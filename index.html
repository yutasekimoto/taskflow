<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskFlow - To-Do アプリ</title>
    
    <!-- PWA設定 -->
    <link rel="manifest" href="#" id="manifest-placeholder">
    
    <!-- iOS特化設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TaskFlow">
    
    <style>
        /* すべてのCSSを内蔵 */
        *, ::before, ::after { box-sizing: border-box; border-width: 0; border-style: solid; border-color: #e5e7eb; }
        html { line-height: 1.5; -webkit-text-size-adjust: 100%; font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
        body { margin: 0; line-height: inherit; }
        .min-h-screen { min-height: 100vh; }
        .bg-gradient-to-br { background-image: linear-gradient(to bottom right, var(--tw-gradient-stops)); }
        .from-blue-50 { --tw-gradient-from: #eff6ff; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(239, 246, 255, 0)); }
        .to-indigo-100 { --tw-gradient-to: #e0e7ff; }
        .p-4 { padding: 1rem; }
        .max-w-2xl { max-width: 42rem; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .text-center { text-align: center; }
        .mb-8 { margin-bottom: 2rem; }
        .mb-4 { margin-bottom: 1rem; }
        .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
        .font-bold { font-weight: 700; }
        .text-gray-800 { color: #1f2937; }
        .mb-2 { margin-bottom: 0.5rem; }
        .text-gray-600 { color: #4b5563; }
        .grid { display: grid; }
        .grid-cols-4 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        .gap-3 { gap: 0.75rem; }
        .mb-6 { margin-bottom: 1.5rem; }
        .bg-white { background-color: #ffffff; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .text-2xl { font-size: 1.5rem; line-height: 2rem; }
        .text-sm { font-size: 0.875rem; line-height: 1.25rem; }
        .text-gray-500 { color: #6b7280; }
        .text-blue-600 { color: #2563eb; }
        .text-green-600 { color: #16a34a; }
        .text-green-500 { color: #22c55e; }
        .text-blue-500 { color: #3b82f6; }
        .text-red-500 { color: #ef4444; }
        .text-white { color: #ffffff; }
        .flex { display: flex; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .flex-1 { flex: 1 1 0%; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .px-6 { padding-left: 1.5rem; padding-right: 1.5rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .border { border-width: 1px; }
        .border-gray-200 { border-color: #e5e7eb; }
        .focus\:outline-none:focus { outline: 2px solid transparent; outline-offset: 2px; }
        .focus\:ring-2:focus { box-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); }
        .focus\:ring-blue-500:focus { --tw-ring-color: #3b82f6; }
        .bg-blue-500 { background-color: #3b82f6; }
        .bg-green-500 { background-color: #22c55e; }
        .bg-gray-500 { background-color: #6b7280; }
        .hover\:bg-blue-600:hover { background-color: #2563eb; }
        .hover\:bg-green-600:hover { background-color: #16a34a; }
        .hover\:bg-gray-600:hover { background-color: #4b5563; }
        .hover\:bg-gray-50:hover { background-color: #f9fafb; }
        .hover\:bg-blue-50:hover { background-color: #eff6ff; }
        .hover\:bg-green-50:hover { background-color: #f0fdf4; }
        .transition-colors { transition-property: color, background-color, border-color; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .overflow-x-auto { overflow-x: auto; }
        .whitespace-nowrap { white-space: nowrap; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .p-8 { padding: 2rem; }
        .text-lg { font-size: 1.125rem; line-height: 1.75rem; }
        .text-gray-400 { color: #9ca3af; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .duration-200 { transition-duration: 200ms; }
        .border-l-4 { border-left-width: 4px; }
        .border-l-gray-300 { border-left-color: #d1d5db; }
        .border-l-blue-500 { border-left-color: #3b82f6; }
        .border-l-green-500 { border-left-color: #22c55e; }
        .opacity-60 { opacity: 0.6; }
        .border-t-4 { border-top-width: 4px; }
        .border-t-blue-400 { border-top-color: #60a5fa; }
        .cursor-move { cursor: move; }
        .flex-shrink-0 { flex-shrink: 0; }
        .hover\:text-gray-600:hover { color: #4b5563; }
        .hover\:text-blue-500:hover { color: #3b82f6; }
        .hover\:text-red-500:hover { color: #ef4444; }
        .min-w-0 { min-width: 0px; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .py-1 { padding-top: 0.25rem; padding-bottom: 0.25rem; }
        .font-medium { font-weight: 500; }
        .line-through { text-decoration: line-through; }
        .text-xs { font-size: 0.75rem; line-height: 1rem; }
        .rounded-full { border-radius: 9999px; }
        .bg-gray-100 { background-color: #f3f4f6; }
        .bg-blue-100 { background-color: #dbeafe; }
        .bg-green-100 { background-color: #dcfce7; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-8 { margin-top: 2rem; }
        .gap-1 { gap: 0.25rem; }
        .p-2 { padding: 0.5rem; }
        .rounded { border-radius: 0.25rem; }
        .pb-4 { padding-bottom: 1rem; }
        .border-t { border-top-width: 1px; }
        .border-gray-100 { border-color: #f3f4f6; }
        .block { display: block; }
        .text-gray-700 { color: #374151; }
        .w-full { width: 100%; }
        .w-12 { width: 3rem; }
        .h-12 { height: 3rem; }
        .w-4 { width: 1rem; }
        .h-4 { height: 1rem; }
        .w-16 { width: 1rem; }
        .h-16 { height: 1rem; }
        .focus\:border-transparent:focus { border-color: transparent; }
        .resize-none { resize: none; }
        .text-gray-500 { color: #6b7280; }
        .hidden { display: none; }
        .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }
        .from-blue-500 { --tw-gradient-from: #3b82f6; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(59, 130, 246, 0)); }
        .to-purple-500 { --tw-gradient-to: #8b5cf6; }
        .animate-spin { animation: spin 1s linear infinite; }
        .border-2 { border-width: 2px; }
        .border-blue-500 { border-color: #3b82f6; }
        .border-t-transparent { border-top-color: transparent; }
        .disabled\:bg-gray-400:disabled { background-color: #9ca3af; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root">
        <div id="loading" style="display: flex; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(to bottom right, #eff6ff, #e0e7ff);">
            <div style="text-align: center;">
                <div style="width: 50px; height: 50px; border: 4px solid #e5e7eb; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
                <p style="color: #6b7280; font-size: 18px;">TaskFlow を起動中...</p>
            </div>
        </div>
    </div>

    <script>
        // SVGアイコンをコンポーネントとして定義
        const icons = {
            Plus: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 0 14"/></svg>`,
            X: () => `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
            Edit2: () => `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7H6a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2-2v-1"/><path d="M20.385 6.585a2.1 2.1 0 0 0-2.97-2.97L9 12v3h3l8.385-8.415z"/><path d="m16 5 3 3"/></svg>`,
            Check: () => `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>`,
            Circle: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/></svg>`,
            Play: () => `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5,3 19,12 5,21"/></svg>`,
            Pause: () => `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>`,
            GripVertical: () => `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>`,
            ChevronDown: () => `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`,
            ChevronUp: () => `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>`,
            FileText: () => `<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14,2 14,8 20,8"/></svg>`,
            Cloud: () => `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>`,
            Wifi: () => `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 14.4c1.5-2 4-3.4 7-3.4s5.5 1.4 7 3.4"/><path d="M5 18.3c1-1.2 2.5-2.3 4-2.3s3 1.1 4 2.3"/><circle cx="12" cy="20" r="1"/></svg>`,
            WifiOff: () => `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="2" y1="2" x2="22" y2="22"/><path d="M10.66 10.66A8 8 0 0 0 3 17"/><path d="M16.85 16.85A8 8 0 0 0 21 17"/><circle cx="12" cy="20" r="1"/></svg>`
        };

        // アプリのメインロジック
        class TodoApp {
            constructor() {
                this.tasks = [];
                this.newTask = '';
                this.filter = 'all';
                this.editingId = null;
                this.editingText = '';
                this.expandedTasks = new Set();
                this.draggedTask = null;
                this.dragOverIndex = null;
                this.isOnline = navigator.onLine;
                this.isSyncing = false;

                // ユーザーID生成
                this.userId = this.getUserId();

                // ストレージキー
                this.STORAGE_KEY = `taskflow_tasks_${this.userId}`;
                this.FILTER_KEY = `taskflow_filter_${this.userId}`;
                this.EXPANDED_KEY = `taskflow_expanded_${this.userId}`;

                this.setupEventListeners();
                this.loadData();
                this.render();
            }

            getUserId() {
                let uid = localStorage.getItem('taskflow_user_id');
                if (!uid) {
                    uid = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    localStorage.setItem('taskflow_user_id', uid);
                }
                return uid;
            }

            setupEventListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.render();
                });
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.render();
                });
            }

            loadData() {
                try {
                    const savedTasks = localStorage.getItem(this.STORAGE_KEY);
                    const savedFilter = localStorage.getItem(this.FILTER_KEY);
                    const savedExpanded = localStorage.getItem(this.EXPANDED_KEY);
                    
                    if (savedTasks) {
                        this.tasks = JSON.parse(savedTasks);
                    }
                    if (savedFilter) {
                        this.filter = savedFilter;
                    }
                    if (savedExpanded) {
                        this.expandedTasks = new Set(JSON.parse(savedExpanded));
                    }
                } catch (error) {
                    console.error('データの読み込みに失敗しました:', error);
                }
            }

            saveData() {
                try {
                    localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.tasks));
                    localStorage.setItem(this.FILTER_KEY, this.filter);
                    localStorage.setItem(this.EXPANDED_KEY, JSON.stringify([...this.expandedTasks]));
                } catch (error) {
                    console.error('データの保存に失敗しました:', error);
                }
            }

            addTask() {
                if (this.newTask.trim()) {
                    const task = {
                        id: Date.now(),
                        text: this.newTask.trim(),
                        memo: '',
                        status: 'todo',
                        createdAt: new Date().toLocaleString(),
                        completedAt: null,
                        order: this.tasks.length
                    };
                    this.tasks.push(task);
                    this.newTask = '';
                    this.saveData();
                    this.render();
                }
            }

            deleteTask(id) {
                this.tasks = this.tasks.filter(task => task.id !== id);
                this.saveData();
                this.render();
            }

            updateTaskStatus(id, newStatus) {
                this.tasks = this.tasks.map(task => {
                    if (task.id === id) {
                        const updatedTask = { ...task, status: newStatus };
                        if (newStatus === 'completed') {
                            updatedTask.completedAt = new Date().toLocaleString();
                        } else if (task.status === 'completed' && newStatus !== 'completed') {
                            updatedTask.completedAt = null;
                        }
                        return updatedTask;
                    }
                    return task;
                });
                this.saveData();
                this.render();
            }

            updateTaskMemo(id, memo) {
                this.tasks = this.tasks.map(task =>
                    task.id === id ? { ...task, memo } : task
                );
                this.saveData();
                this.render();
            }

            toggleTaskExpansion(id) {
                if (this.expandedTasks.has(id)) {
                    this.expandedTasks.delete(id);
                } else {
                    this.expandedTasks.add(id);
                }
                this.saveData();
                this.render();
            }

            startEditing(id, text) {
                this.editingId = id;
                this.editingText = text;
                this.render();
            }

            saveEdit() {
                if (this.editingText.trim()) {
                    this.tasks = this.tasks.map(task =>
                        task.id === this.editingId ? { ...task, text: this.editingText.trim() } : task
                    );
                }
                this.editingId = null;
                this.editingText = '';
                this.saveData();
                this.render();
            }

            cancelEdit() {
                this.editingId = null;
                this.editingText = '';
                this.render();
            }

            setFilter(filter) {
                this.filter = filter;
                this.saveData();
                this.render();
            }

            getFilteredTasks() {
                return this.tasks
                    .filter(task => {
                        if (this.filter === 'completed') return task.status === 'completed';
                        if (this.filter === 'in-progress') return task.status === 'in-progress';
                        if (this.filter === 'todo') return task.status === 'todo';
                        if (this.filter === 'all') return task.status !== 'completed';
                        return true;
                    })
                    .sort((a, b) => a.order - b.order);
            }

            getStats() {
                return {
                    total: this.tasks.filter(task => task.status !== 'completed').length,
                    todo: this.tasks.filter(task => task.status === 'todo').length,
                    inProgress: this.tasks.filter(task => task.status === 'in-progress').length,
                    completed: this.tasks.filter(task => task.status === 'completed').length
                };
            }

            getStatusColor(status) {
                switch (status) {
                    case 'todo': return 'border-l-gray-300';
                    case 'in-progress': return 'border-l-blue-500';
                    case 'completed': return 'border-l-green-500';
                    default: return 'border-l-gray-300';
                }
            }

            render() {
                const stats = this.getStats();
                const filteredTasks = this.getFilteredTasks();

                const html = `
                    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                        <div class="max-w-2xl mx-auto">
                            <!-- Header -->
                            <div class="text-center mb-8">
                                <div class="flex items-center justify-center gap-3 mb-4">
                                    <div class="w-12 h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl flex items-center justify-center">
                                        ${icons.Cloud()}
                                    </div>
                                    <h1 class="text-4xl font-bold text-gray-800">TaskFlow</h1>
                                </div>
                                <p class="text-gray-600">革新的なタスク管理アプリ</p>
                                
                                <!-- 接続状態 -->
                                <div class="mt-4 flex items-center justify-center gap-2">
                                    ${this.isOnline ? `
                                        ${icons.Wifi()}
                                        <span class="text-green-600 text-sm">オンライン</span>
                                    ` : `
                                        ${icons.WifiOff()}
                                        <span class="text-red-500 text-sm">オフライン</span>
                                    `}
                                    ${this.isSyncing ? `
                                        <div class="flex items-center gap-2 ml-4">
                                            <div class="w-4 h-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                                            <span class="text-blue-600 text-sm">同期中...</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <!-- Stats -->
                            <div class="grid grid-cols-4 gap-3 mb-6">
                                <div class="bg-white rounded-lg p-4 shadow-sm text-center">
                                    <div class="text-2xl font-bold text-gray-800">${stats.total}</div>
                                    <div class="text-sm text-gray-600">アクティブ</div>
                                </div>
                                <div class="bg-white rounded-lg p-4 shadow-sm text-center">
                                    <div class="text-2xl font-bold text-gray-500">${stats.todo}</div>
                                    <div class="text-sm text-gray-600">未着手</div>
                                </div>
                                <div class="bg-white rounded-lg p-4 shadow-sm text-center">
                                    <div class="text-2xl font-bold text-blue-600">${stats.inProgress}</div>
                                    <div class="text-sm text-gray-600">進行中</div>
                                </div>
                                <div class="bg-white rounded-lg p-4 shadow-sm text-center">
                                    <div class="text-2xl font-bold text-green-600">${stats.completed}</div>
                                    <div class="text-sm text-gray-600">完了済み</div>
                                </div>
                            </div>

                            <!-- Add Task -->
                            <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                                <div class="flex gap-2">
                                    <input
                                        type="text"
                                        id="newTaskInput"
                                        value="${this.newTask}"
                                        placeholder="新しいタスクを入力..."
                                        class="flex-1 px-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    />
                                    <button
                                        onclick="app.addTask()"
                                        class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-2"
                                    >
                                        ${icons.Plus()}
                                        追加
                                    </button>
                                </div>
                            </div>

                            <!-- Filter -->
                            <div class="flex gap-2 mb-6 overflow-x-auto">
                                <button
                                    onclick="app.setFilter('all')"
                                    class="px-4 py-2 rounded-lg transition-colors whitespace-nowrap ${
                                        this.filter === 'all' 
                                            ? 'bg-blue-500 text-white' 
                                            : 'bg-white text-gray-700 hover:bg-gray-50'
                                    }"
                                >
                                    アクティブ (${stats.total})
                                </button>
                                <button
                                    onclick="app.setFilter('todo')"
                                    class="px-4
