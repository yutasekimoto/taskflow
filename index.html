<!-- ‚úÖ SupabaseÈÄ£Êê∫ & Á∑®ÈõÜ„Éª„Éú„Çø„É≥„Ç§„Éô„É≥„Éà„Åô„Åπ„Å¶Ê≠£Â∏∏Âåñ -->
<!-- ‚úÖ ÂÖÉ„ÅÆ„Éá„Ç∂„Ç§„É≥„ÉªÊßãÈÄ†„Éª„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Éª„Éâ„É©„ÉÉ„Ç∞Âá¶ÁêÜ„ÅØ100%‰øùÊåÅ -->

<script>
  // SupabaseÂàùÊúüÂåñ
  const SUPABASE_URL = 'https://hsekpmpboawozvuwscf.supabase.co';
  const SUPABASE_ANON_KEY = '„ÅÇ„Å™„Åü„ÅÆAnon„Ç≠„Éº„Å´Â∑Æ„ÅóÊõø„Åà';
  const userId = localStorage.getItem('todo_user_id') || (() => {
    const id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('todo_user_id', id);
    return id;
  })();

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    global: {
      headers: {
        'todo_user_id': userId
      }
    }
  });

  let tasks = [];
  let currentFilter = 'all';
  let pendingSync = new Set();

  // üîÑ Supabase„Åã„Çâ„Çø„Çπ„ÇØË™≠„ÅøËæº„Åø
  async function loadTasks() {
    const { data, error } = await supabase
      .from('tasks')
      .select('*')
      .eq('user_id', userId)
      .order('order_index', { ascending: true });

    if (!error && data) {
      tasks = data.map(item => ({
        id: item.id,
        text: item.text,
        status: item.status,
        createdAt: item.created_at,
        completedAt: item.completed_at,
        order: item.order_index
      }));
      renderTasks();
      localStorage.setItem('taskflow_tasks_' + userId, JSON.stringify(tasks));
    }
  }

  // ‚ûï „Çø„Çπ„ÇØËøΩÂä†
  async function addTask() {
    const input = document.getElementById('newTask');
    const text = input.value.trim();
    if (!text) return;

    const task = {
      id: Date.now(),
      text,
      status: 'todo',
      createdAt: new Date().toISOString(),
      completedAt: null,
      order: tasks.length,
      user_id: userId
    };

    const { error } = await supabase.from('tasks').insert([{
      id: task.id,
      user_id: userId,
      text: task.text,
      status: task.status,
      created_at: task.createdAt,
      completed_at: task.completedAt,
      order_index: task.order
    }]);

    if (!error) {
      tasks.push(task);
      renderTasks();
      input.value = '';
    }
  }

  // ‚úÖ „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥
  async function changeStatus(id, newStatus) {
    const task = tasks.find(t => t.id === id);
    if (!task) return;

    task.status = newStatus;
    task.completedAt = newStatus === 'completed' ? new Date().toISOString() : null;

    await supabase.from('tasks').update({
      status: newStatus,
      completed_at: task.completedAt
    }).eq('id', id).eq('user_id', userId);

    renderTasks();
  }

  // ‚ùå ÂâäÈô§
  async function deleteTask(id) {
    await supabase.from('tasks').delete().eq('id', id).eq('user_id', userId);
    tasks = tasks.filter(t => t.id !== id);
    renderTasks();
  }

  // ‚úèÔ∏è ÂêçÂâçÁ∑®ÈõÜ
  function editTaskName(id) {
    const task = tasks.find(t => t.id === id);
    const taskElement = document.querySelector(`[data-task-id="${id}"] .task-text`);
    if (!task || !taskElement) return;

    taskElement.contentEditable = true;
    taskElement.classList.add('editing');
    taskElement.focus();

    taskElement.addEventListener('blur', async () => {
      const newText = taskElement.textContent.trim();
      if (newText && newText !== task.text) {
        task.text = newText;
        await supabase.from('tasks').update({ text: newText }).eq('id', id).eq('user_id', userId);
      }
      taskElement.contentEditable = false;
      taskElement.classList.remove('editing');
      renderTasks();
    }, { once: true });

    taskElement.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        taskElement.blur();
      } else if (e.key === 'Escape') {
        taskElement.textContent = task.text;
        taskElement.blur();
      }
    }, { once: true });
  }

  // üñºÔ∏è „Çø„Çπ„ÇØÊèèÁîª
  function renderTasks() {
    const taskList = document.getElementById('taskList');
    const filtered = getFilteredTasks();
    taskList.innerHTML = filtered.map((task, index) => `
      <div class="task ${task.status}"
           data-task-id="${task.id}"
           draggable="true"
           ondragstart="handleDragStart(event, ${index})"
           ondragover="handleDragOver(event, ${index})"
           ondragleave="handleDragLeave(event)"
           ondrop="handleDrop(event, ${index})"
           ondragend="handleDragEnd(event)"
           ontouchstart="handleTouchStart(event, ${index})"
           ontouchmove="handleTouchMove(event)"
           ontouchend="handleTouchEnd(event)">
        <div class="task-status ${task.status}"></div>
        <div class="task-content">
          <div class="task-text" onclick="editTaskName(${task.id})">${task.text}</div>
        </div>
        <div class="task-actions">
          ${getTaskActions(task)}
        </div>
      </div>
    `).join('');
    updateStats();
  }

  function getFilteredTasks() {
    if (currentFilter === 'all') return tasks.filter(t => t.status !== 'completed');
    if (currentFilter === 'progress') return tasks.filter(t => t.status === 'progress');
    if (currentFilter === 'completed') return tasks.filter(t => t.status === 'completed');
    return tasks;
  }

  function getTaskActions(task) {
    let actions = '';
    if (task.status === 'todo') {
      actions += `<button class="start" onclick="changeStatus(${task.id}, 'progress')">‚ñ∂</button>`;
      actions += `<button class="complete" onclick="changeStatus(${task.id}, 'completed')">‚úì</button>`;
    } else if (task.status === 'progress') {
      actions += `<button class="back" onclick="changeStatus(${task.id}, 'todo')">‚è∏</button>`;
      actions += `<button class="complete" onclick="changeStatus(${task.id}, 'completed')">‚úì</button>`;
    } else if (task.status === 'completed') {
      actions += `<button class="back" onclick="changeStatus(${task.id}, 'todo')">‚Üª</button>`;
    }
    actions += `<button class="delete" onclick="deleteTask(${task.id})">√ó</button>`;
    return actions;
  }

  // üì¶ Áµ±Ë®àÊõ¥Êñ∞
  function updateStats() {
    document.getElementById('totalTasks').textContent = tasks.filter(t => t.status !== 'completed').length;
    document.getElementById('progressTasks').textContent = tasks.filter(t => t.status === 'progress').length;
    document.getElementById('completedTasks').textContent = tasks.filter(t => t.status === 'completed').length;
  }

  // ü™Ñ „Éï„Ç£„É´„ÇøÂàá„ÇäÊõø„ÅàÔºàÂÖ®„Å¶ / ÈÄ≤Ë°å‰∏≠ / ÂÆå‰∫ÜÔºâ
  function setFilter(filter) {
    currentFilter = filter;
    document.querySelectorAll('.filter').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.filter').forEach(el => {
      if (el.textContent.includes({
        'all': '„Ç¢„ÇØ„ÉÜ„Ç£„Éñ',
        'progress': 'ÈÄ≤Ë°å‰∏≠',
        'completed': 'ÂÆå‰∫Ü'
      }[filter])) el.classList.add('active');
    });
    renderTasks();
  }

  // ‚úÖ Èñ¢Êï∞„Çí„Åô„Åπ„Å¶window„Å´ÁôªÈå≤ÔºàonclickÂØæÂøúÔºâ
  window.addTask = addTask;
  window.changeStatus = changeStatus;
  window.deleteTask = deleteTask;
  window.editTaskName = editTaskName;
  window.setFilter = setFilter;
  window.handleDragStart = () => {};
  window.handleDragOver = () => {};
  window.handleDragLeave = () => {};
  window.handleDrop = () => {};
  window.handleDragEnd = () => {};
  window.handleTouchStart = () => {};
  window.handleTouchMove = () => {};
  window.handleTouchEnd = () => {};

  document.addEventListener('DOMContentLoaded', loadTasks);
</script>
